#!/bin/bash
# =============================================================================
# Project Docker Build Helper Script
# =============================================================================
# Thin wrapper that manages Docker containers. ALL actual work runs inside Docker.
# This script only uses: docker, docker-compose (no other host tools required)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$SCRIPT_DIR"

format_duration() {
    local total="$1"
    local h=$((total / 3600))
    local m=$(((total % 3600) / 60))
    local s=$((total % 60))

    if [ "$h" -gt 0 ]; then
        printf "%dh %dm %ds" "$h" "$m" "$s"
    elif [ "$m" -gt 0 ]; then
        printf "%dm %ds" "$m" "$s"
    else
        printf "%ds" "$s"
    fi
}

print_elapsed() {
    local rc="$1"
    local elapsed=$((SECONDS - PROJECT_START_SECONDS))
    local pretty
    pretty="$(format_duration "$elapsed")"
    echo "[INFO] Elapsed time: $pretty (exit=$rc)"
}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

show_help() {
    echo -e "${CYAN}Yocto RPi5 RAUC Docker Build System${NC}"
    echo ""
    echo "Usage: $0 <command>"
    echo ""
    echo "Container Management:"
    echo "  start       - Start the Docker build container"
    echo "  stop        - Stop the Docker build container"
    echo "  shell       - Enter the Docker container shell"
    echo "  status      - Show container status"
    echo "  logs        - Show container logs"
    echo "  purge       - Remove all Docker volumes (full reset)"
    echo ""
    echo "Build Commands (run inside Docker):"
    echo "  setup       - Clone Yocto layers"
    echo "  keys        - Generate RAUC signing keys"
    echo "  build       - Run the full Yocto build"
    echo "  bundle      - Build RAUC update bundle"
    echo "  clean       - Remove build artifacts and cache (keeps downloads/sstate)"
    echo "  clean-state - Reset a single recipe (usage: $0 clean-state <recipe>)"
    echo "  clean-failed - Reset the most recently failed recipe"
    echo "  write-image - Copy built images to output/ directory"
    echo ""
}

# Ensure container is running, start if not
ensure_container() {
    cd "$PROJECT_DIR"
    if ! docker-compose ps --status running 2>/dev/null | grep -q yocto-build; then
        log_info "Container not running, starting..."
        cmd_start
    fi
}

 fix_permissions() {
     cd "$PROJECT_DIR"
     docker-compose exec -T -u root yocto-build bash -lc "
         mkdir -p /yocto/project/build/tmp /yocto/project/downloads /yocto/project/sstate-cache /yocto/project/layers/meta-rpi5-rauc/files /yocto/project/.tmp &&
         uid=\$(id -u yocto) && gid=\$(id -g yocto) &&
         chown -R \$uid:\$gid /yocto/project/build/tmp /yocto/project/downloads /yocto/project/sstate-cache /yocto/project/layers/meta-rpi5-rauc/files /yocto/project/.tmp
     "
 }

cmd_start() {
    log_info "Building and starting Docker container..."
    cd "$PROJECT_DIR"
    
    # Get current user/group IDs for proper file permissions
    export USER_ID=$(id -u)
    export GROUP_ID=$(id -g)
    
    docker-compose build --pull --no-cache
    docker-compose up -d

     log_info "Ensuring mounted directories are writable by build user..."
     fix_permissions
    log_info "Container started. Use '$0 shell' to enter."
}

cmd_stop() {
    log_info "Stopping Docker container..."
    cd "$PROJECT_DIR"
    docker-compose down
}

cmd_shell() {
    ensure_container
    log_info "Entering Docker container..."
    cd "$PROJECT_DIR"
    docker-compose exec -u yocto yocto-build bash
}

cmd_status() {
    cd "$PROJECT_DIR"
    docker-compose ps
}

cmd_logs() {
    cd "$PROJECT_DIR"
    docker-compose logs -f
}

cmd_purge() {
    log_warn "This will remove ALL Docker volumes including downloads and sstate-cache!"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd "$PROJECT_DIR"
        docker-compose down -v
        log_info "All volumes removed."
    else
        log_info "Cancelled."
    fi
}

# === Commands that run INSIDE Docker ===

cmd_setup() {
    ensure_container
    log_info "Cloning Yocto layers inside Docker..."
    cd "$PROJECT_DIR"
    docker-compose exec -u yocto yocto-build ./scripts/setup-layers.sh
}

cmd_keys() {
    ensure_container
    log_info "Generating RAUC signing keys inside Docker..."
    cd "$PROJECT_DIR"
    docker-compose exec -u yocto yocto-build ./scripts/generate-rauc-keys.sh
}

cmd_build() {
    ensure_container
    log_info "Starting Yocto build inside Docker..."
    cd "$PROJECT_DIR"
    docker-compose exec -u yocto yocto-build ./scripts/build.sh build "$@"
}

cmd_bundle() {
    ensure_container
    log_info "Building RAUC bundle inside Docker..."
    cd "$PROJECT_DIR"
    docker-compose exec -u yocto yocto-build ./scripts/build.sh build rpi5-rauc-bundle
}

cmd_clean() {
    ensure_container
    log_warn "Removing build artifacts and cache..."
    cd "$PROJECT_DIR"
    docker-compose exec -u root yocto-build rm -rf /yocto/project/build/tmp /yocto/project/build/cache
    fix_permissions
    log_info "Clean complete. Downloads and sstate-cache preserved."
}

cmd_clean_state() {
    ensure_container
    local recipe="$1"
    if [ -z "$recipe" ]; then
        log_error "Missing recipe name"
        echo "Usage: $0 clean-state <recipe>"
        exit 1
    fi

    log_warn "Resetting recipe via cleansstate: $recipe"
    cd "$PROJECT_DIR"
    docker-compose exec -u yocto yocto-build bash -lc "
        source /yocto/project/layers/poky/oe-init-build-env /yocto/project/build >/dev/null &&
        bitbake -c cleansstate \"$recipe\"
    "
}

cmd_clean_failed() {
    ensure_container
    log_warn "Detecting most recently failed task..."
    cd "$PROJECT_DIR"

    docker-compose exec -u yocto yocto-build bash -lc "
        set -e
        source /yocto/project/layers/poky/oe-init-build-env /yocto/project/build >/dev/null

        latest_log=\$(find /yocto/project/build/tmp/work -type f -path '*/temp/log.do_*' -printf '%T@ %p\\n' 2>/dev/null | sort -nr | head -n 1 | cut -d' ' -f2-)
        if [ -z \"\$latest_log\" ]; then
            echo 'No task failure logs found under build/tmp/work (nothing to clean)' >&2
            exit 1
        fi

        recipe=\$(echo \"\$latest_log\" | sed -E 's#.*/work/[^/]+/([^/]+)/.*#\\1#')
        if [ -z \"\$recipe\" ] || [ \"\$recipe\" = \"\$latest_log\" ]; then
            echo \"Failed to derive recipe name from: \$latest_log\" >&2
            exit 1
        fi

        echo \"Most recent failure log: \$latest_log\" >&2
        echo \"Running: bitbake -c cleansstate \$recipe\" >&2
        bitbake -c cleansstate \"\$recipe\"
    "
}

cmd_write_image() {
    ensure_container
    log_info "Copying built images to output/ directory..."
    cd "$PROJECT_DIR"
 
    if [ "${1:-}" = "--force-wic" ]; then
        log_info "Forcing WIC image regeneration inside Docker..."
        docker-compose exec -u yocto yocto-build bash -lc "
            set -e
            source /yocto/project/layers/poky/oe-init-build-env /yocto/project/build >/dev/null
            bitbake -c do_image_wic -f rpi5-rauc-image
        "
    fi

    docker-compose exec -u yocto yocto-build bash -c "
        mkdir -p /yocto/project/output
        if [ -d /yocto/project/build/tmp/deploy/images/raspberrypi5 ]; then
            cp -v /yocto/project/build/tmp/deploy/images/raspberrypi5/*.wic* /yocto/project/output/ 2>/dev/null || true
            cp -v /yocto/project/build/tmp/deploy/images/raspberrypi5/*.raucb /yocto/project/output/ 2>/dev/null || true
            echo ''
            echo 'Images copied to output/ directory'
        else
            echo 'No images found. Have you run a build yet?'
        fi
    "
}

# Main
cd "$PROJECT_DIR"

PROJECT_START_SECONDS=$SECONDS
trap 'print_elapsed $?' EXIT

case "${1:-help}" in
    start)   cmd_start ;;
    stop)    cmd_stop ;;
    shell)   cmd_shell ;;
    status)  cmd_status ;;
    logs)    cmd_logs ;;
    purge)   cmd_purge ;;
    setup)   cmd_setup ;;
    keys)    cmd_keys ;;
    build)   shift; cmd_build "$@" ;;
    bundle)  cmd_bundle ;;
    clean)   cmd_clean ;;
    clean-state) shift; cmd_clean_state "$@" ;;
    clean-failed) cmd_clean_failed ;;
    write-image) cmd_write_image ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
